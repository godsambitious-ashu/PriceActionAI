{# templates/index.html #}
{% extends "base.html" %}

{% block title %}
  AI-Powered Stock Data Visualization
{% endblock %}

{% block head %}
  <!-- Load your global CSS here (e.g., styles.css) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <!-- Include Font Awesome for Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-pK3C3v5rrFw5qc8PbWdH0AWI3oQ6K/HjlTrJL+3WXpsrH3sO0x+CMa9N5y4L2cG30uLrQyJ3Zt3sE4P8e4eFgw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
{% endblock %}

{% block gpt_section %}
  {% if enable_gpt %}
    <!-- GPT Search Bar -->
    <div class="gpt-section">
      <form id="gptForm">
        <input type="hidden" name="stock_code" value="{{ current_stock_code }}">
        <!-- AI Input -->
        <input
          type="text"
          id="gptInput"
          name="message"
          class="custom-form-control"
          placeholder="Ask AI..."
          required
        />
        <!-- AI Submit Button -->
        <button type="submit" class="custom-btn custom-btn-primary">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block search_section %}
  <!-- Stock Search Form -->
  <div class="search-section">
    <form method="POST">
      <!-- Stock Search Input -->
      <input
        type="text"
        id="stock_code"
        name="stock_code"
        class="custom-form-control"
        placeholder="Stock"
        required
      />
      <!-- Timeframe Select -->
      <select id="period" name="period" class="custom-form-select">
        <option value="1d">1D</option>
        <option value="5d">5D</option>
        <option value="1mo">1M</option>
        <option value="3mo">3M</option>
        <option value="6mo">6M</option>
        <option value="1y" selected>1Y</option>
        <option value="2y">2Y</option>
        <option value="5y">5Y</option>
        <option value="ytd">YTD</option>
        <option value="max">Max</option>
      </select>
      <!-- Search Button -->
      <button type="submit" class="custom-btn custom-btn-success search-btn">
        <i class="fas fa-search"></i>
      </button>
    </form>
  </div>
{% endblock %}

{% block content %}
  {% if chat_history %}
    {% set chat = chat_history[-1] %}
    <div class="chat-panel">
      <h6 class="text-center mb-1">{{ chat.stock_code }} - {{ chat.timestamp }}</h6>
      <div id="chatDisplay" style="max-height: 200px; overflow-y: auto;">
        {% if chat.user_query %}
          <div class="chat-message user">
            <div class="message"><strong>You:</strong> {{ chat.user_query }}</div>
          </div>
        {% endif %}
        {% if chat.gpt_answer %}
          <div class="chat-message assistant">
            <div class="message"><strong>GPT:</strong> {{ chat.gpt_answer }}</div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Stock Charts Section -->
    <div id="stock_section">
      {% if charts %}
        <div class="charts-section">
          <div class="d-flex align-items-center justify-content-start gap-3 flex-wrap mb-2">
            <!-- Stock/Index Toggle Buttons -->
            <div class="button-panel mb-0">
              <button
                type="button"
                class="custom-btn custom-btn-success active"
                onclick="showData('stock')"
              >
                Stock
              </button>
              {% if index_charts %}
                <button
                  type="button"
                  class="custom-btn custom-btn-success"
                  onclick="showData('index')"
                >
                  Index
                </button>
              {% else %}
                <button
                  type="button"
                  class="custom-btn custom-btn-success"
                  disabled
                >
                  Index
                </button>
              {% endif %}
            </div>

            <!-- Stock Interval Buttons -->
            <div class="button-panel mb-0">
              <button
                type="button"
                class="custom-btn custom-btn-primary active"
                onclick="showChart('stock', '1d')"
              >1D</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('stock', '1wk')"
              >1W</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('stock', '1mo')"
              >1M</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('stock', '3mo')"
              >3M</button>
            </div>
          </div>

          <!-- Stock Charts Loop -->
          {% for interval, chart_data in charts.items() %}
            <div class="chart-container mb-2"
                 id="chart_container_stock_{{ interval }}"
                 {% if interval != '1d' %}style="display:none;"{% endif %}>
              <!-- Price Label Container -->
              <div class="chart-price-label" id="price_label_stock_{{ interval }}"></div>
              
              <!-- Fullscreen + Fresh Zones on the same line -->
              <div class="d-flex align-items-center justify-content-end gap-3 flex-wrap mb-2">
                <button
                  type="button"
                  class="custom-btn custom-btn-secondary btn-sm"
                  onclick="toggleFullscreen('chart_container_stock_{{ interval }}')"
                >
                  <i class="fas fa-expand"></i>
                </button>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="fresh_toggle_stock_{{ interval }}"
                    onchange="toggleFreshZones('stock', '{{ interval }}')"
                  >
                  <label class="form-check-label" for="fresh_toggle_stock_{{ interval }}">
                    Fresh zones
                  </label>
                </div>
              </div>

              <!-- Plotly HTML for this chart (All Zones) -->
              <div id="chart_all_zones_stock_{{ interval }}">
                {{ chart_data.all_zones | safe }}
              </div>
              <!-- Plotly HTML for this chart (Fresh Zones) -->
              <div id="chart_fresh_zones_stock_{{ interval }}" style="display:none;">
                {{ chart_data.fresh_zones | safe }}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Index Charts Section -->
    {% if index_charts %}
      <div id="index_section" style="display:none;">
        <div class="charts-section">
          <div class="d-flex align-items-center justify-content-start gap-3 flex-wrap mb-2">
            <!-- Stock/Index Toggle Buttons -->
            <div class="button-panel mb-0">
              <button
                type="button"
                class="custom-btn custom-btn-success"
                onclick="showData('stock')"
              >
                Stock
              </button>
              <button
                type="button"
                class="custom-btn custom-btn-success active"
                onclick="showData('index')"
              >
                Index
              </button>
            </div>

            <!-- Index Interval Buttons -->
            <div class="button-panel mb-0">
              <button
                type="button"
                class="custom-btn custom-btn-primary active"
                onclick="showChart('index', '1d')"
              >1D</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('index', '1wk')"
              >1W</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('index', '1mo')"
              >1M</button>
              <button
                type="button"
                class="custom-btn custom-btn-primary"
                onclick="showChart('index', '3mo')"
              >3M</button>
            </div>
          </div>

          <!-- Index Charts Loop -->
          {% for interval, chart_data in index_charts.items() %}
            <div class="chart-container mb-2"
                 id="chart_container_index_{{ interval }}"
                 {% if interval != '1d' %}style="display:none;"{% endif %}>
              <!-- Price Label Container -->
              <div class="chart-price-label" id="price_label_index_{{ interval }}"></div>
              
              <!-- Fullscreen + Fresh Zones on the same line -->
              <div class="d-flex align-items-center justify-content-end gap-3 flex-wrap mb-2">
                <button
                  type="button"
                  class="custom-btn custom-btn-secondary btn-sm"
                  onclick="toggleFullscreen('chart_container_index_{{ interval }}')"
                >
                  <i class="fas fa-expand"></i>
                </button>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="fresh_toggle_index_{{ interval }}"
                    onchange="toggleFreshZones('index', '{{ interval }}')"
                  >
                  <label class="form-check-label" for="fresh_toggle_index_{{ interval }}">
                    Fresh zones
                  </label>
                </div>
              </div>

              <!-- Plotly HTML for this chart (All Zones) -->
              <div id="chart_all_zones_index_{{ interval }}">
                {{ chart_data.all_zones | safe }}
              </div>
              <!-- Plotly HTML for this chart (Fresh Zones) -->
              <div id="chart_fresh_zones_index_{{ interval }}" style="display:none;">
                {{ chart_data.fresh_zones | safe }}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // GPT Form Submission
  const gptForm = document.getElementById('gptForm');
  if (gptForm) {
    gptForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const userInput = document.getElementById('gptInput');
      const userMessage = userInput.value.trim();
      if (!userMessage) return;

      try {
        const response = await fetch('/send_message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({ message: userMessage })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
        } else {
          updateChatDisplay(userMessage, data.message);
          userInput.value = "";
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });
  }

  // Update Chat Display
  function updateChatDisplay(userMsg, gptMsg) {
    const chatDisplay = document.getElementById('chatDisplay');
    if (chatDisplay) {
      chatDisplay.innerHTML += `
        <div class="chat-message user">
          <div class="message"><strong>You:</strong> ${userMsg}</div>
        </div>
        <div class="chat-message assistant">
          <div class="message"><strong>GPT:</strong> ${gptMsg}</div>
        </div>
      `;
      chatDisplay.scrollTop = chatDisplay.scrollHeight;
    }
  }

  // Fullscreen Toggle
  window.toggleFullscreen = function(elementId) {
    const chartContainer = document.getElementById(elementId);
    if (!document.fullscreenElement) {
      chartContainer.requestFullscreen().catch(err => {
        alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
      });
    } else {
      document.exitFullscreen();
    }
  };

  // Toggle Fresh Zones
  window.toggleFreshZones = function(dataType, interval) {
    const allZonesDiv = document.getElementById(`chart_all_zones_${dataType}_${interval}`);
    const freshZonesDiv = document.getElementById(`chart_fresh_zones_${dataType}_${interval}`);
    const checkbox = document.getElementById(`fresh_toggle_${dataType}_${interval}`);

    if (checkbox.checked) {
      allZonesDiv.style.display = 'none';
      freshZonesDiv.style.display = 'block';
    } else {
      allZonesDiv.style.display = 'block';
      freshZonesDiv.style.display = 'none';
    }
  };

  // Show/Hide Data Type Sections
  window.showData = function(dataType) {
    const stockSection = document.getElementById('stock_section');
    const indexSection = document.getElementById('index_section');
    if (!stockSection || !indexSection) return;

    if (dataType === 'stock') {
      stockSection.style.display = 'block';
      indexSection.style.display = 'none';
    } else {
      stockSection.style.display = 'none';
      indexSection.style.display = 'block';
    }
  };

  // Show/Hide Charts Based on Interval
  window.showChart = function(dataType, selectedInterval) {
    const intervals = ['1d', '1wk', '1mo', '3mo'];
    intervals.forEach(function(interval) {
      const container = document.getElementById(`chart_container_${dataType}_${interval}`);
      const button = document.querySelector(`.button-panel button[onclick="showChart('${dataType}', '${interval}')"]`);
      if (container) {
        if (interval === selectedInterval) {
          container.style.display = 'block';
          if (button) button.classList.add('active');
        } else {
          container.style.display = 'none';
          if (button) button.classList.remove('active');
        }
      }
    });
  };

  // ========== PRICE LABEL SETUP ========== //
  function setupPriceLabels() {
    // Iterate over all chart containers
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(function(container) {
      // We'll have two possible Plotly charts inside: chart_all_zones_* and chart_fresh_zones_*
      const chartAllZones = container.querySelector('[id^="chart_all_zones_"]');
      const chartFreshZones = container.querySelector('[id^="chart_fresh_zones_"]');
      const priceLabel = container.querySelector('.chart-price-label');

      // Attach events to whichever .js-plotly-plot is inside these containers
      attachEvents(chartAllZones, priceLabel, container);
      attachEvents(chartFreshZones, priceLabel, container);
    });
  }

  // The critical fix: attach the hover events to the actual .js-plotly-plot element
  function attachEvents(chartDiv, priceLabel, container) {
    if (!chartDiv || !priceLabel) return;

    // The real Plotly chart is inside .js-plotly-plot
    const plotlyChart = chartDiv.querySelector('.js-plotly-plot');
    if (!plotlyChart) return; // If not found, no chart is here

    // On hover, we get the data points. We'll place a label at the correct position.
    plotlyChart.on('plotly_hover', function(data) {
      // Usually data.points[0] has our x/y info
      if (!data || !data.points || !data.points.length) return;
      const point = data.points[0];
      const price = point.y;

      // The event gives the mouse position in data.event
      const mouseEvent = data.event;
      const containerRect = container.getBoundingClientRect();
      const mouseX = mouseEvent.clientX - containerRect.left;
      const mouseY = mouseEvent.clientY - containerRect.top;

      // Update the label text
      priceLabel.textContent = `Price: ${price}`;

      // Calculate label position so it's near the cursor, on the right side
      const labelWidth = priceLabel.offsetWidth;
      const labelHeight = priceLabel.offsetHeight;
      const offsetX = 10; // Slight offset to the right
      const offsetY = -10; // Slight offset up

      let left = mouseX + offsetX;
      let top = mouseY + offsetY;

      // Boundary checks so label doesn't overflow container
      if (left + labelWidth > containerRect.width) {
        left = mouseX - labelWidth - offsetX;
      }
      if (top < 0) top = 0;
      if (top + labelHeight > containerRect.height) {
        top = containerRect.height - labelHeight;
      }

      // Apply to label
      priceLabel.style.left = left + 'px';
      priceLabel.style.top = top + 'px';
      priceLabel.style.display = 'block';
    });

    // On unhover, hide the label
    plotlyChart.on('plotly_unhover', function() {
      priceLabel.style.display = 'none';
    });
  }

  // Initialize price labels after a short delay
  setTimeout(setupPriceLabels, 1000);

  // Default state
  showData('stock');
  showChart('stock', '1d');
});
</script>
{% endblock %}
