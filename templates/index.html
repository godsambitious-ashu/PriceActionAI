{% extends "base.html" %}

{% block title %}Stock Data Visualization{% endblock %}

{% block gpt_section %}
  {% if enable_gpt %}
    <!-- GPT Search Bar at the top -->
    <div class="gpt-section mb-4">
      <form method="POST" action="/customgpt">
        <div class="input-group">
          <input type="hidden" name="stock_code" value="{{ current_stock_code }}">
          <input
            type="text"
            name="gpt_query"
            class="form-control"
            placeholder="Ask our AI assistant..."
            required
          />
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Ask GPT
          </button>
        </div>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block content %}
  <!-- User Information Display -->
  <div class="user-info text-center mb-4">
    <h2>Welcome, {{ name }}!</h2>
    <p>Your email: {{ email }}</p>
  </div>

  <!-- Form Section -->
  <div class="form-section mb-5">
    <h1>Stock Data Visualization</h1>
    <form method="POST">
      <div class="row g-3 justify-content-center">
        <div class="col-md-5">
          <label for="stock_code" class="form-label">Stock Code:</label>
          <input
            type="text"
            id="stock_code"
            name="stock_code"
            class="form-control"
            placeholder="e.g., AAPL, GOOGL"
            required
          />
        </div>
        <div class="col-md-5">
          <label for="period" class="form-label">Period:</label>
          <select id="period" name="period" class="form-select" required>
            <option value="1d">1 Day</option>
            <option value="5d">5 Days</option>
            <option value="1mo">1 Month</option>
            <option value="3mo">3 Months</option>
            <option value="6mo">6 Months</option>
            <option value="1y" selected>1 Year</option>
            <option value="2y">2 Years</option>
            <option value="5y">5 Years</option>
            <option value="10y">10 Years</option>
            <option value="ytd">Year to Date</option>
            <option value="max">Max</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-chart-line me-2"></i> Get Data
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Error Section -->
  {% if error %}
    <div class="error">
      {{ error }}
    </div>
  {% endif %}

  <!-- Charts and Chat Section -->
  {% if chat_history %}
    <div class="row-main">
      <!-- Include the sidebar -->
      {% include "sidebar.html" %}

      <!-- Main Content for Selected Chat -->
      <div class="main-content" id="mainContent">
        {% for chat in chat_history %}
          {% set chat_id = loop.index0 %}
          <div
            class="chat-panel"
            data-chat-id="{{ chat_id }}"
            {% if chat_id != active_chat_id %}style="display:none;"{% endif %}
          >
            <h4>{{ chat.stock_code }} - {{ chat.timestamp }}</h4>

            {% if chat.user_query %}
              <div class="chat-message user">
                <div class="message">
                  <strong>You:</strong> {{ chat.user_query }}
                </div>
              </div>
            {% endif %}
            
            {% if chat.gpt_answer %}
              <div class="chat-message assistant">
                <div class="message">
                  <strong>GPT:</strong> {{ chat.gpt_answer }}
                </div>
              </div>
            {% endif %}

            <!-- Display Charts Related to This Chat (Only for Active Chat) -->
            {% if chat_id == active_chat_id and charts %}
              <div class="charts-section mt-4">
                <h5>Candlestick Charts</h5>
                {% for interval, chart_data in charts.items() %}
                  <div class="chart-container mb-4" id="chart_container_{{ chat_id }}_{{ interval }}">
                    <div class="d-flex justify-content-between align-items-center">
                      <h6>{{ interval }} Interval</h6>
                      <!-- Fullscreen Button -->
                      <button 
                        class="btn btn-secondary btn-sm" 
                        onclick="toggleFullscreen('chart_container_{{ chat_id }}_{{ interval }}')">
                        Fullscreen
                      </button>
                    </div>
                    
                    <div class="toggle-section mb-2">
                      <label for="fresh_toggle_{{ chat_id }}_{{ interval }}">
                        Show only fresh demand zones:
                      </label>
                      <label class="toggle-switch">
                        <input
                          type="checkbox"
                          id="fresh_toggle_{{ chat_id }}_{{ interval }}"
                          onchange="toggleFreshZones({{ chat_id }}, '{{ interval }}')"
                        />
                        <span class="slider"></span>
                      </label>
                    </div>

                    <div id="chart_all_zones_{{ chat_id }}_{{ interval }}">
                      {{ chart_data.all_zones | safe }}
                    </div>
                    <div
                      id="chart_fresh_zones_{{ chat_id }}_{{ interval }}"
                      style="display:none;"
                    >
                      {{ chart_data.fresh_zones | safe }}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
{% endblock %}